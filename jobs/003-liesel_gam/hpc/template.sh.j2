#!/bin/bash
#SBATCH --partition={{SBATCH_PARTITION}}
#SBATCH --cpus-per-task={{SBATCH_CPUS_PER_TASK}}
#SBATCH --mem={{SBATCH_MEM}}
#SBATCH -A {{SBATCH_ACCOUNT}}
#SBATCH -t {{SBATCH_TIME}}
#SBATCH --output={{SLURM_STDOUT_DIR}}/%A_%a.out
#SBATCH --error={{SLURM_STDERR_DIR}}/%A_%a.err
#SBATCH --array=1-{{N_REMAINING}}%{{SBATCH_ARRAY_MAX_CONCURRENT}}
#SBATCH --mail-type=all

# -e: Exit the script immediately if any command returns a non-zero exit status.
# -o pipefail: A pipeline fails if any command in the pipeline fails, not just the last one.
set -eo pipefail

source ~/.bashrc
source ~/.dotenv

cd $HOME/{{REMOTE_REPO_DIR}}

conda activate r-4.5
source .venv/bin/activate
which python

echo "=== DEBUG: Shell executables ==="
which conda || true
which R || true
which Rscript || true
which python || true
python -V || true

echo "=== DEBUG: Conda prefix / R_HOME ==="
echo "CONDA_PREFIX=$CONDA_PREFIX"
echo "R_HOME=$R_HOME"

echo "=== DEBUG: What does this R see? ==="
Rscript -e 'cat("R.home(): ", R.home(), "\n"); cat("libPaths:\n"); print(.libPaths()); cat("has svglite? ", requireNamespace("svglite", quietly=TRUE), "\n")' || true

echo "=== DEBUG: What does Python think R is? ==="
python - <<'PY'
import os, sys
print("sys.executable:", sys.executable)
print("R_HOME env:", os.environ.get("R_HOME"))
try:
    import ryp
except Exception as e:
    print("ryp import failed:", repr(e))
PY

export R_HOME="$(R RHOME)"
export LD_LIBRARY_PATH="$R_HOME/lib:$LD_LIBRARY_PATH"

echo $R_HOME
echo $LD_LIBRARY_PATH

IDX=$SLURM_ARRAY_TASK_ID
JOBROW=$(printf '%s\n' "{{CONDITION_INDICES}}" | sed -n "${IDX}p")
PADDED_JOBROW=$(printf "%04d" "$JOBROW")
LOGFILE="{{LOG_DIR}}/run-${PADDED_JOBROW}-captured.log"

# Optional: skip if already finished
if [ -e "{{FINISHED_DIR}}/$JOBROW" ]; then
  echo "Condition $JOBROW already finished. Skipping."
  exit 0
fi

ln -s $HOME/{{REMOTE_REPO_DIR}}/{{JOBDIR}}/run.qmd {{JOBDIR}}/run-$JOBROW.qmd
trap "unlink {{JOBDIR}}/run-$JOBROW.qmd" EXIT

# NO_COLOR and TERM=dumb are just so that the captured _output
# from quarto is not rendered weirdly in the log file
NO_COLOR=1 TERM=dumb quarto render {{JOBDIR}}/run-$JOBROW.qmd \
    --output - \
    --to gfm \
    --output-dir _output/{{JOBDIR}}/$JOBROW \
    -P JOB_ROW:$JOBROW \
    -P JOB_DIR:{{JOBDIR}} \
    -P JOB_TESTING:False \
    >> $LOGFILE 2>&1

rm -r _output/{{JOBDIR}}/$JOBROW

# mark done
: > "{{FINISHED_DIR}}/$JOBROW"